# 영상 대본 기반 맥락 이해 데이터 생성, 적재 파이프라인 구축

## 1. 개요

영상 대본 데이터를 LLM을 활용해 정형 데이터로 추출하는 자동화 파이프라인.
단순 요약을 넘어 영상의 주제, 핵심 키워드, 카테고리 분류 및 브랜드/제품의 맥락 정보 구조화를 목표로 함.

시스템은 두 가지 핵심 모듈로 구성.
- **메인 분석 파이프라인**: 영상 스크립트에서 종합 분석 정보와 맥락을 1차 추출.
- **맥락 분류 모듈**: 추출된 개별 맥락을 사전 정의된 체계에 따라 유형별로 분류하는 후처리 담당.

## 2. 시스템 아키텍처

이벤트 기반 아키텍처와 배치 처리를 모두 지원하는 유연한 구조로 설계.

### 2.1. 실행 모드
- **Event-driven**: 메시지 큐를 통해 신규 영상 처리 요청을 실시간으로 처리. 즉각적인 분석이 필요할 경우 사용.
- **Workflow**: 워크플로우 스케줄링. 데이터 스토어에서 특정 조건의 대량 데이터를 가져와 일괄 처리.

![시스템 플로우](video-context-flow.png)

## 3. 메인 분석 파이프라인: 다단계 처리

단일 프롬프트가 아닌, 여러 단계에 걸쳐 최적의 프롬프트를 동적으로 선택하고 결과를 정제하는 전략 사용.

### 3.1. 1단계: 사전 분류
데이터의 특징에 따라, 추출할 결과 데이터를 지정.
불필요한 데이터에 과한 프롬프트가 사용되는 것을 방지하기 위한 사전 필터링.

### 3.2. 2단계: 동적 프롬프트 라우팅
입력 데이터 특성에 따라 각각에 특화된 프롬프트를 동적으로 선택.
- **스크립트 길이**: 일정 길이를 초과하는 스크립트는 분할 처리에 특화된 프롬프트와 로직을 사용.


### 3.3. 3단계: 결과 정제
초기 LLM 응답을 여러 단계의 후처리를 거쳐 품질 향상.
- **분할 결과 통합**: 스크립트 분할 처리 시, 각 세그먼트의 결과를 취합하여 자연스러운 전체 결과물로 재구성.
- **길이 조정**: 생성된 결과 중 일정 기준을 미달하는 항목은, 별도 LLM 요청을 통해 기준에 맞게 변환.
- **감성 정보 확장**: 개별 언급 단위로 추출된 감성 정보를 바탕으로, 브랜드 및 제품 전체에 대한 종합적인 감성을 추론하여 부여 (논리적 확장과 병행).

## 4. 맥락 분류 모듈: 2차 데이터 가공

메인 파이프라인이 추출한 비정형의 맥락 텍스트를 2차 가공.
사전 정의된 다수의 유형(대분류: `['기능적', '감성적']`)으로 자동 분류.
이 과정을 통해 정성적 데이터를 정형 데이터로 변환.

## 5. 안정성 확보 전략

LLM 기반 시스템의 불안정성을 극복하기 위한 방어 로직 구현.

### 5.1. JSON 형식 오류 자동 보정
- **문제점**: LLM이 종종 문법에 맞지 않는 JSON을 반환하여 일부 실패하는 요청 발생.
- **해결책**: JSON 파싱 실패 시, 실패 케이스를 스토리지에 업로드, 해당 케이스들 모니터링 후 빈도가 높은 케이스는 논리적으로 처리할 수 있도록 고도화. 논리적 포매팅 최종 실패 시 LLM 요청을 통한 보정.

### 5.2. 감성 분석 결과 보정 알고리즘
- **문제점**: 소수의 긍정/부정 언급이 다수의 중립적 언급에 의해 희석되어 전체 감성이 왜곡되는 현상 발생.
- **해결책**: 가중치 보정 알고리즘 도입. 긍정 또는 부정 언급이 하나라도 존재할 경우, 중립 언급의 가중치를 중간의 영향력을 발휘하도록 줄여서 논리적으로 최종 감성을 계산. 이를 통해 소수의 핵심적인 감성 표현이 무시되지 않도록 보정.

